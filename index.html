<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visiting Mum Calendar</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
</head>
<body class="bg-slate-50 text-slate-900 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        // ==========================================
        // 1. PASTE YOUR FIREBASE CONFIG HERE
        // ==========================================
        const firebaseConfig = {
  apiKey: "AIzaSyAsJTCDzhZ8TkeCNbwedBv7RpmCY2RL9WA",
  authDomain: "visiting-mum-app.firebaseapp.com",
  projectId: "visiting-mum-app",
  storageBucket: "visiting-mum-app.firebasestorage.app",
  messagingSenderId: "371002024983",
  appId: "1:371002024983:web:973e76d0b7d7faeceea852"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();

        // ==========================================
        // 2. APP CODE STARTS HERE
        // ==========================================
        const { useState, useEffect, useMemo } = React;

        // --- Inline SVG Icons ---
        const IconCalendar = ({className}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>;
        const IconUser = ({className}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>;
        const IconClock = ({className}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>;
        const IconCheckCircle = ({className}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>;
        const IconAlertCircle = ({className}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>;
        const IconTrash = ({className}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>;
        const IconListChecks = ({className}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>;
        const IconCalendarPlus = ({className}) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line><line x1="10" y1="14" x2="14" y2="14"></line><line x1="12" y1="12" x2="12" y2="16"></line></svg>;

        const SLOT_TYPES = ["Morning Slot", "Lunchtime Slot", "Afternoon Slot", "Evening Slot"];
        const PRESET_NAMES = ["John", "Gary", "Brian", "Carda"];
        const DAILY_LIMIT = 3; 

        // Current Date Configuration
        const TODAY = new Date(2026, 1, 24); 

        const SLOT_TIMES = {
            "Morning Slot": { start: 10, end: 11, startMin: 0, endMin: 30 },
            "Lunchtime Slot": { start: 12, end: 14, startMin: 30, endMin: 0 },
            "Afternoon Slot": { start: 15, end: 17, startMin: 30, endMin: 0 },
            "Evening Slot": { start: 18, end: 20, startMin: 30, endMin: 0 }
        };

        const App = () => {
            const [bookings, setBookings] = useState({});
            const [selectedDay, setSelectedDay] = useState(TODAY);
            const [visitorName, setVisitorName] = useState("");
            const [otherName, setOtherName] = useState("");
            const [message, setMessage] = useState({ text: "", type: "" });
            const [isLoading, setIsLoading] = useState(true);

            // Fetch Data from Firebase Real-time Listener
            useEffect(() => {
                const docRef = db.collection("visiting_mum").doc("calendar");
                
                const unsubscribe = docRef.onSnapshot((doc) => {
                    if (doc.exists) {
                        setBookings(doc.data().bookings || {});
                    } else {
                        // If document doesn't exist yet, create it with empty bookings
                        docRef.set({ bookings: {} });
                        setBookings({});
                    }
                    setIsLoading(false);
                }, (error) => {
                    console.error("Error fetching data: ", error);
                    setMessage({ text: "Error connecting to database.", type: "error" });
                    setIsLoading(false);
                });

                // Cleanup listener on unmount
                return () => unsubscribe();
            }, []);

            const formatDateKey = (date) => {
                return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
            };

            const calendarDays = useMemo(() => {
                const startOfWeek = new Date(TODAY);
                startOfWeek.setDate(TODAY.getDate() - TODAY.getDay()); 
                return Array.from({ length: 21 }, (_, i) => {
                    const d = new Date(startOfWeek);
                    d.setDate(startOfWeek.getDate() + i);
                    return d;
                });
            }, []);

            // Handle Booking with Firebase
            const handleBooking = async (dateStr, slotName) => {
                const finalName = visitorName === "Other" ? otherName : visitorName;
                if (!finalName.trim()) {
                    setMessage({ text: "Please enter your name.", type: "error" });
                    return;
                }

                const dayBookings = bookings[dateStr]?.slots || {};
                const bookedCount = Object.keys(dayBookings).length;

                if (bookedCount >= DAILY_LIMIT && !dayBookings[slotName]) {
                    setMessage({ text: `Maximum of ${DAILY_LIMIT} slots already booked.`, type: "error" });
                    return;
                }

                const updatedBookings = {
                    ...bookings,
                    [dateStr]: {
                        slots: {
                            ...dayBookings,
                            [slotName]: {
                                name: finalName,
                                timestamp: Date.now()
                            }
                        }
                    }
                };
                
                try {
                    // Save to Firebase
                    await db.collection("visiting_mum").doc("calendar").set({ bookings: updatedBookings }, { merge: true });
                    setMessage({ text: "Slot booked successfully!", type: "success" });
                    setVisitorName("");
                    setOtherName("");
                } catch (error) {
                    setMessage({ text: "Failed to book slot.", type: "error" });
                }
                setTimeout(() => setMessage({ text: "", type: "" }), 3000);
            };

            // Handle Delete with Firebase
            const handleDelete = async (dateStr, slotName) => {
                const dayBookings = { ...(bookings[dateStr]?.slots || {}) };
                delete dayBookings[slotName];

                const updatedBookings = {
                    ...bookings,
                    [dateStr]: {
                        slots: dayBookings
                    }
                };

                try {
                    // Update Firebase
                    await db.collection("visiting_mum").doc("calendar").set({ bookings: updatedBookings }, { merge: true });
                    setMessage({ text: "Booking removed.", type: "success" });
                } catch (error) {
                    setMessage({ text: "Failed to remove booking.", type: "error" });
                }
                setTimeout(() => setMessage({ text: "", type: "" }), 3000);
            };

            const downloadICS = (date, slotName, visitorName) => {
                // (ICS Download logic remains completely unchanged from original)
                const times = SLOT_TIMES[slotName];
                const startDate = new Date(date);
                startDate.setHours(times.start, times.startMin, 0);
                const endDate = new Date(date);
                endDate.setHours(times.end, times.endMin, 0);

                const formatICSDate = (d) => d.toISOString().replace(/-|:|\.\d+/g, '');

                const icsContent = [
                    'BEGIN:VCALENDAR',
                    'VERSION:2.0',
                    'PRODID:-//Visiting Mum App//EN',
                    'BEGIN:VEVENT',
                    `UID:${Date.now()}@visitingmum.app`,
                    `DTSTAMP:${formatICSDate(new Date())}`,
                    `DTSTART:${formatICSDate(startDate)}`,
                    `DTEND:${formatICSDate(endDate)}`,
                    `SUMMARY:Visiting Mum (${slotName})`,
                    `DESCRIPTION:Hospital visit booked by ${visitorName}.`,
                    'LOCATION:Hospital',
                    'END:VEVENT',
                    'END:VCALENDAR'
                ].join('\r\n');

                const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.setAttribute('download', `visiting-mum-${formatDateKey(date)}.ics`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const upcomingOverview = useMemo(() => {
                return Array.from({ length: 4 }, (_, i) => {
                    const d = new Date(TODAY);
                    d.setDate(TODAY.getDate() + i);
                    const dateKey = formatDateKey(d);
                    return {
                        date: d,
                        dateKey,
                        slots: bookings[dateKey]?.slots || {}
                    };
                });
            }, [bookings]);

            if (isLoading) {
                return <div className="min-h-screen flex items-center justify-center bg-slate-50 text-slate-500 font-bold">Loading Calendar...</div>;
            }

            return (
                <div className="min-h-screen bg-slate-50 text-slate-900 p-4 md:p-8 font-sans">
                    <div className="max-w-4xl mx-auto">
                        <header className="bg-white rounded-2xl p-6 shadow-sm border border-slate-200 mb-8">
                            <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
                                <div>
                                    <h1 className="text-2xl font-bold text-blue-600 flex items-center gap-2">
                                        <IconCalendar className="w-8 h-8 text-blue-600" />
                                        Visiting Mum
                                    </h1>
                                    <p className="text-slate-500 text-sm mt-1">Today is Tuesday, Feb 24, 2026 â€¢ Max {DAILY_LIMIT} slots per day</p>
                                </div>
                                <div className="bg-blue-50 px-4 py-2 rounded-xl border border-blue-100">
                                    <span className="text-blue-700 text-sm font-semibold">Showing: Current & Next 2 Weeks</span>
                                </div>
                            </div>
                        </header>

                        {message.text && (
                            <div className={`mb-6 p-4 rounded-xl flex items-center gap-3 transition-opacity ${
                                message.type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                            }`}>
                                {message.type === 'success' ? <IconCheckCircle className="w-5 h-5" /> : <IconAlertCircle className="w-5 h-5" />}
                                {message.text}
                            </div>
                        )}

                        <section className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden mb-8">
                            <div className="bg-slate-800 text-white p-4 flex items-center gap-2">
                                <IconListChecks className="w-5 h-5" />
                                <h2 className="font-bold">Booking Overview: Next 4 Days</h2>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-4 divide-y md:divide-y-0 md:divide-x divide-slate-100">
                                {upcomingOverview.map((day) => {
                                    const bookedSlots = Object.entries(day.slots).sort((a, b) => SLOT_TYPES.indexOf(a[0]) - SLOT_TYPES.indexOf(b[0]));
                                    const remaining = DAILY_LIMIT - bookedSlots.length;
                                    return (
                                        <div key={day.dateKey} className="p-5">
                                            <div className="mb-3">
                                                <p className="text-xs font-bold text-slate-400 uppercase tracking-wider">
                                                    {day.date.toLocaleDateString(undefined, { weekday: 'short' })}
                                                </p>
                                                <p className="text-lg font-bold text-slate-800">
                                                    {day.date.toLocaleDateString(undefined, { day: 'numeric', month: 'short' })}
                                                </p>
                                            </div>
                                            <div className="space-y-2">
                                                {bookedSlots.length > 0 ? (
                                                    bookedSlots.map(([slot, data]) => (
                                                        <div key={slot} className="group flex flex-col text-xs p-2 bg-blue-50 rounded-lg border border-blue-100 relative">
                                                            <span className="font-bold text-blue-900">{slot.split(' ')[0]}</span>
                                                            <span className="text-blue-700">{data.name}</span>
                                                            <button 
                                                                onClick={() => downloadICS(day.date, slot, data.name)}
                                                                className="absolute top-1 right-1 opacity-0 group-hover:opacity-100 transition-opacity p-1 bg-white rounded shadow-sm"
                                                                title="Sync"
                                                            >
                                                                <IconCalendarPlus className="w-3 h-3 text-blue-600" />
                                                            </button>
                                                        </div>
                                                    ))
                                                ) : (
                                                    <div className="text-xs text-slate-400 flex items-center gap-2 italic p-2 border border-dashed border-slate-200 rounded-lg">
                                                        <div className="w-1.5 h-1.5 rounded-full bg-slate-300"></div>
                                                        No visits booked
                                                    </div>
                                                )}
                                                {remaining > 0 && bookedSlots.length > 0 && (
                                                    <div className="text-[10px] text-green-600 font-bold px-2 mt-1 flex items-center gap-1">
                                                        <span className="w-1 h-1 bg-green-500 rounded-full"></span>
                                                        {remaining} {remaining === 1 ? 'Slot' : 'Slots'} Open
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </section>

                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                            <div className="lg:col-span-2 bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                                <div className="grid grid-cols-7 bg-slate-50 border-b border-slate-200">
                                    {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(d => (
                                        <div key={d} className="py-3 text-center text-xs font-bold text-slate-400 uppercase tracking-wider">{d}</div>
                                    ))}
                                </div>
                                <div className="grid grid-cols-7">
                                    {calendarDays.map((date, idx) => {
                                        const dateStr = formatDateKey(date);
                                        const dayBookings = bookings[dateStr]?.slots || {};
                                        const count = Object.keys(dayBookings).length;
                                        const isSelected = selectedDay && formatDateKey(selectedDay) === dateStr;
                                        const isToday = date.toDateString() === TODAY.toDateString();
                                        const isPast = date < TODAY && !isToday;

                                        return (
                                            <button
                                                key={dateStr}
                                                onClick={() => setSelectedDay(date)}
                                                className={`h-28 p-2 border-r border-b border-slate-100 flex flex-col items-start text-left transition-all relative
                                                    ${isPast ? 'bg-slate-50 opacity-60' : 'hover:bg-blue-50'}
                                                    ${isSelected ? 'bg-blue-50 ring-2 ring-inset ring-blue-500 z-10' : ''}
                                                    ${isToday ? 'bg-amber-50/30' : ''}
                                                `}
                                            >
                                                <div className="flex justify-between items-start w-full">
                                                    <span className={`text-sm font-semibold rounded-full w-7 h-7 flex items-center justify-center 
                                                        ${isToday ? 'bg-blue-600 text-white' : (isSelected ? 'text-blue-600' : 'text-slate-700')}`}>
                                                        {date.getDate()}
                                                    </span>
                                                    {isToday && <span className="text-[10px] font-bold text-blue-600 uppercase">Today</span>}
                                                </div>
                                                
                                                <div className="flex flex-col gap-1 mt-2 w-full overflow-hidden">
                                                    {Object.entries(dayBookings)
                                                        .sort((a, b) => SLOT_TYPES.indexOf(a[0]) - SLOT_TYPES.indexOf(b[0]))
                                                        .map(([slot, data]) => (
                                                        <div key={slot} className="text-[10px] truncate bg-blue-100 text-blue-700 px-1 rounded font-medium">
                                                            {data.name}
                                                        </div>
                                                    ))}
                                                    {count < DAILY_LIMIT && !isPast && (
                                                        <div className="text-[10px] text-slate-300 font-medium italic">+ Open</div>
                                                    )}
                                                </div>
                                                {count >= DAILY_LIMIT && <span className="text-[9px] text-red-500 font-black mt-1 uppercase">Full</span>}
                                            </button>
                                        );
                                    })}
                                </div>
                            </div>

                            <div className="space-y-6">
                                <div className="bg-white rounded-2xl p-6 shadow-sm border border-slate-200">
                                    <h2 className="text-lg font-bold mb-4 flex items-center gap-2">
                                        <IconUser className="w-5 h-5 text-blue-500" />
                                        {selectedDay.toLocaleDateString(undefined, { day: 'numeric', month: 'long', weekday: 'short' })}
                                    </h2>

                                    <div className="space-y-6">
                                        <div className="space-y-3">
                                            <label className="text-xs font-bold text-slate-500 uppercase">Who is visiting?</label>
                                            <div className="grid grid-cols-2 gap-2">
                                                {PRESET_NAMES.map(name => (
                                                    <button
                                                        key={name}
                                                        onClick={() => { setVisitorName(name); setOtherName(""); }}
                                                        className={`py-2 px-3 rounded-xl border text-sm font-medium transition-all ${
                                                            visitorName === name ? 'bg-blue-600 border-blue-600 text-white shadow-md' : 'bg-white border-slate-200 text-slate-600 hover:border-blue-400'
                                                        }`}
                                                    >
                                                        {name}
                                                    </button>
                                                ))}
                                                <button
                                                    onClick={() => setVisitorName("Other")}
                                                    className={`py-2 px-3 rounded-xl border text-sm font-medium transition-all ${
                                                        visitorName === "Other" ? 'bg-blue-600 border-blue-600 text-white shadow-md' : 'bg-white border-slate-200 text-slate-600 hover:border-blue-400'
                                                    }`}
                                                >
                                                    Other
                                                </button>
                                            </div>
                                            {visitorName === "Other" && (
                                                <input
                                                    type="text"
                                                    placeholder="Type your name..."
                                                    value={otherName}
                                                    onChange={(e) => setOtherName(e.target.value)}
                                                    className="w-full p-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none transition-all"
                                                />
                                            )}
                                        </div>

                                        <div className="space-y-3">
                                            <label className="text-xs font-bold text-slate-500 uppercase">Select a Slot</label>
                                            <div className="space-y-2">
                                                {SLOT_TYPES.map(slot => {
                                                    const dateStr = formatDateKey(selectedDay);
                                                    const booking = bookings[dateStr]?.slots?.[slot];
                                                    const dayFull = Object.keys(bookings[dateStr]?.slots || {}).length >= DAILY_LIMIT;
                                                    const isPast = selectedDay < TODAY && selectedDay.toDateString() !== TODAY.toDateString();

                                                    return (
                                                        <div key={slot} className={`p-4 rounded-xl border transition-all ${
                                                            booking ? 'bg-blue-50 border-blue-200 ring-1 ring-blue-100' : 'bg-white border-slate-200'
                                                        }`}>
                                                            <div className="flex justify-between items-center">
                                                                <span className="font-semibold flex items-center gap-2 text-sm">
                                                                    <IconClock className="w-4 h-4 text-slate-400" />
                                                                    {slot}
                                                                </span>
                                                                <div className="flex items-center gap-1">
                                                                    {booking && (
                                                                        <button
                                                                            onClick={() => downloadICS(selectedDay, slot, booking.name)}
                                                                            className="p-2 text-blue-600 hover:bg-blue-100 rounded-lg transition-colors"
                                                                            title="Sync to Calendar"
                                                                        >
                                                                            <IconCalendarPlus className="w-4 h-4" />
                                                                        </button>
                                                                    )}
                                                                    {booking ? (
                                                                        <button
                                                                            onClick={() => handleDelete(dateStr, slot)}
                                                                            className="p-2 text-red-500 hover:bg-red-50 rounded-lg transition-colors"
                                                                            title="Remove Booking"
                                                                        >
                                                                            <IconTrash className="w-4 h-4" />
                                                                        </button>
                                                                    ) : (
                                                                        !dayFull && !isPast && (
                                                                            <button
                                                                                onClick={() => handleBooking(dateStr, slot)}
                                                                                disabled={!visitorName || (visitorName === "Other" && !otherName)}
                                                                                className="text-xs font-bold px-3 py-1.5 bg-blue-50 text-blue-600 hover:bg-blue-600 hover:text-white rounded-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                                                                            >
                                                                                BOOK
                                                                            </button>
                                                                        )
                                                                    )}
                                                                </div>
                                                            </div>
                                                            {booking ? (
                                                                <p className="text-xs text-blue-700 mt-1 flex items-center justify-between">
                                                                    <span>Booked by <span className="font-bold">{booking.name}</span></span>
                                                                </p>
                                                            ) : (
                                                                dayFull ? (
                                                                    <p className="text-[10px] text-slate-400 italic mt-1">Day is full</p>
                                                                ) : isPast ? (
                                                                    <p className="text-[10px] text-slate-400 italic mt-1">Cannot book past dates</p>
                                                                ) : (
                                                                    <p className="text-[10px] text-slate-400 mt-1">Available</p>
                                                                )
                                                            )}
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <footer className="mt-8 text-center text-slate-400 text-xs">
                            Hospital Policy: Maximum of {DAILY_LIMIT} visitors per day total. Use the <IconCalendarPlus className="inline w-3 h-3" /> icon to add a visit to your personal calendar.
                        </footer>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>