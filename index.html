// Handle Booking with Firebase (Updated for targeted updates)
const handleBooking = async (dateStr, slotName) => {
    const finalName = visitorName === "Other" ? otherName : visitorName;
    if (!finalName.trim()) {
        setMessage({ text: "Please enter your name.", type: "error" });
        return;
    }

    // We still do a quick local check to ensure the day isn't already full
    const dayBookings = bookings[dateStr]?.slots || {};
    const bookedCount = Object.keys(dayBookings).length;

    if (bookedCount >= DAILY_LIMIT && !dayBookings[slotName]) {
        setMessage({ text: `Maximum of ${DAILY_LIMIT} slots already booked.`, type: "error" });
        return;
    }

    try {
        // We use dot-notation to target ONLY this specific date and slot
        // This prevents overwriting other bookings made at the exact same time
        await db.collection("visiting_mum").doc("calendar").update({
            [`bookings.${dateStr}.slots.${slotName}`]: {
                name: finalName,
                timestamp: Date.now()
            }
        });
        
        setMessage({ text: "Slot booked successfully!", type: "success" });
        setVisitorName("");
        setOtherName("");
    } catch (error) {
        console.error("Booking Error: ", error);
        setMessage({ text: "Failed to book slot.", type: "error" });
    }
    
    setTimeout(() => setMessage({ text: "", type: "" }), 3000);
};
